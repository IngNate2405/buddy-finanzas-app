<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Telegram - Buddy Finanzas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>window.PUBLIC_CONFIG_URL='https://buddywspserver.netlify.app/public-config';</script>
    <script type="module" src="firebase-config.js"></script>
    <script>
        // Desactivar console.log en producci√≥n
        if (typeof console !== 'undefined') {
            console.log = function () {};
        }
    </script>
  <script type="module">
    import { collection, query, where, getDocs, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.deleteDoc = deleteDoc;
  </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-[#0f1618] text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#a64fff] to-[#8a2aff] p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-white text-2xl hover:text-gray-300 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-white text-xl font-bold">Configuraci√≥n Telegram</h1>
            </div>
            <span class="text-xs text-gray-400">v2.11.0 - Unified Version Management</span>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-[#1a1f2e] rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#a64fff] mx-auto mb-4"></div>
            <p class="text-white">Conectando con tu sesi√≥n...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="p-6 max-w-4xl mx-auto">
        <!-- Status Card -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fab fa-telegram text-3xl text-blue-400"></i>
                <div>
                    <h2 class="text-xl font-bold">Buddy Finanzas Bot</h2>
                    <p class="text-gray-400">Conecta tu cuenta con Telegram</p>
                </div>
            </div>
            
            <div id="connectionStatus" class="mb-4">
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span id="statusText" class="text-yellow-400">No conectado</span>
                </div>
            </div>

            <div class="bg-[#0f1618] rounded-lg p-4">
                <h3 class="font-semibold mb-2">üì± C√≥mo conectar:</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                    <li>Busca <code class="bg-gray-700 px-2 py-1 rounded">@buddy_finanzas_bot</code> en Telegram</li>
                    <li>Inicia una conversaci√≥n con el bot</li>
                    <li>Env√≠a el comando: <code class="bg-gray-700 px-2 py-1 rounded">/start</code></li>
                    <li>El bot te dar√° un c√≥digo de vinculaci√≥n</li>
                    <li>Ingresa el c√≥digo aqu√≠ abajo</li>
                </ol>
            </div>
        </div>

        <!-- Link Form -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üîó Vincular Cuenta</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        C√≥digo de vinculaci√≥n
                    </label>
                    <input 
                        type="text" 
                        id="linkCode" 
                        placeholder="Ingresa el c√≥digo que te dio el bot (ej: 830950655)"
                        class="w-full px-4 py-3 bg-[#0f1618] border border-gray-600 rounded-lg focus:border-[#a64fff] focus:outline-none"
                    >
                </div>
                
                <button 
                    id="linkButton"
                    onclick="linkTelegramAccount()"
                    class="w-full bg-gradient-to-r from-[#a64fff] to-[#8a2aff] text-white py-3 px-6 rounded-lg font-semibold hover:from-[#8a2aff] hover:to-[#6b1fcc] transition-all duration-200"
                >
                    <i class="fas fa-link mr-2"></i>
                    Vincular Cuenta
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üìù C√≥mo usar el bot</h3>
            
            <div class="space-y-4">
                <div class="bg-[#0f1618] rounded-lg p-4">
                    <h4 class="font-semibold text-green-400 mb-2">üí∞ Registrar Gastos:</h4>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li>‚Ä¢ "Gast√© Q50 en comida"</li>
                        <li>‚Ä¢ "Pagu√© Q200 de renta"</li>
                        <li>‚Ä¢ "Compr√© Q30 en supermercado"</li>
                    </ul>
                </div>
                
                <div class="bg-[#0f1618] rounded-lg p-4">
                    <h4 class="font-semibold text-blue-400 mb-2">üíµ Registrar Ingresos:</h4>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li>‚Ä¢ "Recib√≠ Q3000 de salario"</li>
                        <li>‚Ä¢ "Gan√© Q500 de venta"</li>
                        <li>‚Ä¢ "Ingres√≥ Q100 de inversi√≥n"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Unlink Section -->
        <div class="bg-[#1a1f2e] rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4 text-red-400">‚ö†Ô∏è Desvincular Cuenta</h3>
            <p class="text-gray-400 mb-4">Si quieres desconectar tu cuenta de Telegram:</p>
            <button 
                id="unlinkButton"
                onclick="unlinkTelegramAccount()"
                class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors"
            >
                <i class="fas fa-unlink mr-2"></i>
                Desvincular
            </button>
        </div>
    </main>

    <script>
        let firebaseService = null;
        let currentUser = null;

        // Initialize Firebase - Same logic as 2.html with shared session
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for Firebase to load - same as 2.html
                await new Promise(resolve => {
                    if (window.FirebaseService) {
                        resolve();
                    } else {
                        const checkFirebase = setInterval(() => {
                            if (window.FirebaseService) {
                                clearInterval(checkFirebase);
                                resolve();
                            }
                        }, 100);
                    }
                });

                // Create new instance and assign to global - same as 1.html
                firebaseService = new window.FirebaseService();
                window.firebaseServiceInstance = firebaseService;
                
                // Verify Firebase is properly initialized
                console.log('üî• NEW VERSION - Firebase service created:', firebaseService);
                console.log('üî• NEW VERSION - Firebase db available:', firebaseService.db);
                console.log('üî• NEW VERSION - Firebase auth available:', firebaseService.auth);
                console.log('üî• NEW VERSION - Timestamp:', new Date().toISOString());

                // Wait for real auth state before deciding (handle initial null) - same as 2.html
                firebaseService.onAuthStateChanged((user) => {
                    console.log('Auth state changed in telegram-settings:', user ? user.email : 'No user');
                    if (user) {
                        console.log('User authenticated:', user.email);
                        currentUser = user;
                        window.isAuthReady = true;
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        console.log('About to check Telegram connection...');
                        checkTelegramConnection();
                    } else {
                        console.log('No user in auth state, starting retry...');
                        // Keep overlay visible and continue polling - same as 2.html
                        const poll = () => {
                            const retryUser = firebaseService.getCurrentUser();
                            console.log('Polling check - retryUser:', retryUser ? retryUser.email : 'No user');
                            if (retryUser) {
                                console.log('User found via polling:', retryUser.email);
                                currentUser = retryUser;
                                window.isAuthReady = true;
                                document.getElementById('loadingOverlay').style.display = 'none';
                                console.log('About to check Telegram connection via polling...');
                                checkTelegramConnection();
                            } else {
                                console.log('Still no user, continuing polling...');
                                setTimeout(poll, 1000);
                            }
                        };
                        setTimeout(poll, 1200);
                    }
                });

            } catch (error) {
                console.error('Error initializing Firebase:', error);
                window.location.href = 'login.html';
            }
        });

        function goBack() {
            window.location.href = '1.html';
        }

        async function checkTelegramConnection() {
            try {
                console.log('üî• NEW VERSION - Checking Telegram connection...');
                console.log('üî• NEW VERSION - firebaseService (local):', firebaseService);
                console.log('üî• NEW VERSION - firebaseService (global):', window.firebaseServiceInstance);
                console.log('üî• NEW VERSION - currentUser:', currentUser);
                
                // Use global instance instead of local variable
                const service = window.firebaseServiceInstance || firebaseService;
                if (!service || !currentUser) {
                    console.error('Firebase service or user not available');
                    updateConnectionStatus(false);
                    return;
                }

                // Check if user has Telegram linked
                const telegramUsersRef = collection(service.db, 'telegram_users');
                const q = query(telegramUsersRef, where('firebaseUserId', '==', currentUser.uid));
                const telegramLink = await getDocs(q);

                if (!telegramLink.empty) {
                    const linkData = telegramLink.docs[0].data();
                    console.log('Telegram link found:', linkData);
                    updateConnectionStatus(true, linkData.telegramChatId);
                } else {
                    console.log('No Telegram link found');
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error checking Telegram connection:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected, chatId = null) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const linkButton = document.getElementById('linkButton');
            const unlinkButton = document.getElementById('unlinkButton');

            if (connected) {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                text.textContent = `Conectado (Chat ID: ${chatId})`;
                text.className = 'text-green-400';
                linkButton.style.display = 'none';
                unlinkButton.style.display = 'inline-block';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
                text.textContent = 'No conectado';
                text.className = 'text-yellow-400';
                linkButton.style.display = 'inline-block';
                unlinkButton.style.display = 'none';
            }
        }

        async function linkTelegramAccount() {
            const linkCode = document.getElementById('linkCode').value.trim();
            
            if (!linkCode) {
                alert('Por favor ingresa el c√≥digo de vinculaci√≥n');
                return;
            }

            try {
                // Use global instance
                const service = window.firebaseServiceInstance || firebaseService;
                console.log('linkTelegramAccount - service:', service);
                console.log('linkTelegramAccount - service.db:', service?.db);
                console.log('linkTelegramAccount - currentUser:', currentUser);
                
                if (!service) {
                    alert('‚ùå Error: Servicio de Firebase no disponible');
                    return;
                }

                if (!service.db) {
                    alert('‚ùå Error: Base de datos de Firebase no disponible');
                    return;
                }

                // Save the link to Firestore
                const telegramUsersRef = collection(service.db, 'telegram_users');
                await addDoc(telegramUsersRef, {
                    firebaseUserId: currentUser.uid,
                    telegramChatId: linkCode,
                    linkedAt: new Date(),
                    userEmail: currentUser.email
                });

                alert('‚úÖ Cuenta vinculada exitosamente!');
                checkTelegramConnection();
                document.getElementById('linkCode').value = '';
                
            } catch (error) {
                console.error('Error linking account:', error);
                alert('‚ùå Error vinculando la cuenta. Intenta de nuevo.');
            }
        }

        async function unlinkTelegramAccount() {
            if (!confirm('¬øEst√°s seguro de que quieres desvincular tu cuenta de Telegram?')) {
                return;
            }

            try {
                // Use global instance
                const service = window.firebaseServiceInstance || firebaseService;
                if (!service) {
                    alert('‚ùå Error: Servicio de Firebase no disponible');
                    return;
                }

                // Remove the link from Firestore
                const telegramUsersRef = collection(service.db, 'telegram_users');
                const q = query(telegramUsersRef, where('firebaseUserId', '==', currentUser.uid));
                const telegramLink = await getDocs(q);

                if (!telegramLink.empty) {
                    await deleteDoc(telegramLink.docs[0].ref);
                }

                alert('‚úÖ Cuenta desvinculada exitosamente!');
                checkTelegramConnection();
                
            } catch (error) {
                console.error('Error unlinking account:', error);
                alert('‚ùå Error desvinculando la cuenta. Intenta de nuevo.');
            }
        }
    </script>
</body>
</html>
