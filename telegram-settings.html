<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Telegram - Buddy Finanzas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module" src="firebase-config.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-[#0f1618] text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#a64fff] to-[#8a2aff] p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-white text-2xl hover:text-gray-300 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-white text-xl font-bold">Configuraci√≥n Telegram</h1>
            </div>
            <span class="text-xs text-gray-400">v2.8.0 - Clean App</span>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-[#1a1f2e] rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#a64fff] mx-auto mb-4"></div>
            <p class="text-white">Conectando con tu sesi√≥n...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="p-6 max-w-4xl mx-auto">
        <!-- Status Card -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fab fa-telegram text-3xl text-blue-400"></i>
                <div>
                    <h2 class="text-xl font-bold">Buddy Finanzas Bot</h2>
                    <p class="text-gray-400">Conecta tu cuenta con Telegram</p>
                </div>
            </div>
            
            <div id="connectionStatus" class="mb-4">
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <span id="statusText" class="text-yellow-400">No conectado</span>
                </div>
            </div>

            <div class="bg-[#0f1618] rounded-lg p-4">
                <h3 class="font-semibold mb-2">üì± C√≥mo conectar:</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                    <li>Busca <code class="bg-gray-700 px-2 py-1 rounded">@buddy_finanzas_bot</code> en Telegram</li>
                    <li>Inicia una conversaci√≥n con el bot</li>
                    <li>Env√≠a el comando: <code class="bg-gray-700 px-2 py-1 rounded">/start</code></li>
                    <li>El bot te dar√° un c√≥digo de vinculaci√≥n</li>
                    <li>Ingresa el c√≥digo aqu√≠ abajo</li>
                </ol>
            </div>
        </div>

        <!-- Link Form -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üîó Vincular Cuenta</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        C√≥digo de vinculaci√≥n
                    </label>
                    <input 
                        type="text" 
                        id="linkCode" 
                        placeholder="Ingresa el c√≥digo que te dio el bot (ej: 830950655)"
                        class="w-full px-4 py-3 bg-[#0f1618] border border-gray-600 rounded-lg focus:border-[#a64fff] focus:outline-none"
                    >
                </div>
                
                <button 
                    id="linkButton"
                    onclick="linkTelegramAccount()"
                    class="w-full bg-gradient-to-r from-[#a64fff] to-[#8a2aff] text-white py-3 px-6 rounded-lg font-semibold hover:from-[#8a2aff] hover:to-[#6b1fcc] transition-all duration-200"
                >
                    <i class="fas fa-link mr-2"></i>
                    Vincular Cuenta
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-[#1a1f2e] rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">üìù C√≥mo usar el bot</h3>
            
            <div class="space-y-4">
                <div class="bg-[#0f1618] rounded-lg p-4">
                    <h4 class="font-semibold text-green-400 mb-2">üí∞ Registrar Gastos:</h4>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li>‚Ä¢ "Gast√© Q50 en comida"</li>
                        <li>‚Ä¢ "Pagu√© Q200 de renta"</li>
                        <li>‚Ä¢ "Compr√© Q30 en supermercado"</li>
                    </ul>
                </div>
                
                <div class="bg-[#0f1618] rounded-lg p-4">
                    <h4 class="font-semibold text-blue-400 mb-2">üíµ Registrar Ingresos:</h4>
                    <ul class="text-sm text-gray-300 space-y-1">
                        <li>‚Ä¢ "Recib√≠ Q3000 de salario"</li>
                        <li>‚Ä¢ "Gan√© Q500 de venta"</li>
                        <li>‚Ä¢ "Ingres√≥ Q100 de inversi√≥n"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Unlink Section -->
        <div class="bg-[#1a1f2e] rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4 text-red-400">‚ö†Ô∏è Desvincular Cuenta</h3>
            <p class="text-gray-400 mb-4">Si quieres desconectar tu cuenta de Telegram:</p>
            <button 
                id="unlinkButton"
                onclick="unlinkTelegramAccount()"
                class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors"
            >
                <i class="fas fa-unlink mr-2"></i>
                Desvincular
            </button>
        </div>
    </main>

    <script>
        let firebaseService = null;
        let currentUser = null;

        // Initialize Firebase - Same logic as 1.html and 2.html
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to be ready
            let retries = 0;
            while (!window.firebaseServiceInstance && retries < 20) {
                await new Promise(resolve => setTimeout(resolve, 500));
                retries++;
            }

            if (window.firebaseServiceInstance) {
                firebaseService = window.firebaseServiceInstance;
                
                // Set global auth ready flag
                window.isAuthReady = false;
                
                // Check if user is already authenticated
                const initialUser = firebaseService.auth.currentUser;
                if (initialUser) {
                    console.log('User already authenticated:', initialUser.email);
                    currentUser = initialUser;
                    window.isAuthReady = true;
                    document.getElementById('loadingOverlay').style.display = 'none';
                    checkTelegramConnection();
                    return; // Exit early if user is already authenticated
                }
                
                // Listen for auth state changes
                firebaseService.auth.onAuthStateChanged((user) => {
                    console.log('Auth state changed:', user ? user.email : 'No user');
                    if (user) {
                        console.log('User authenticated:', user.email);
                        currentUser = user;
                        window.isAuthReady = true;
                        // Hide loading overlay
                        document.getElementById('loadingOverlay').style.display = 'none';
                        checkTelegramConnection();
                    } else {
                        console.log('No user authenticated, redirecting to login');
                        window.location.href = 'login.html';
                    }
                });
                
                // Retry mechanism with timeout - same as 1.html and 2.html
                setTimeout(() => {
                    if (!window.isAuthReady) {
                        console.log('Auth not ready after timeout, retrying...');
                        // Try to get current user directly
                        const currentUser = firebaseService.auth.currentUser;
                        if (currentUser) {
                            console.log('Found current user:', currentUser.email);
                            window.isAuthReady = true;
                            document.getElementById('loadingOverlay').style.display = 'none';
                            checkTelegramConnection();
                        } else {
                            console.log('No current user found, redirecting to login');
                            window.location.href = 'login.html';
                        }
                    }
                }, 5000);
                
                // Polling loop to check auth status - same as 1.html and 2.html
                const checkAuthLoop = () => {
                    if (!window.isAuthReady) {
                        const currentUser = firebaseService.auth.currentUser;
                        console.log('Polling check - currentUser:', currentUser ? currentUser.email : 'No user');
                        if (currentUser) {
                            console.log('Auth ready via polling:', currentUser.email);
                            window.isAuthReady = true;
                            document.getElementById('loadingOverlay').style.display = 'none';
                            checkTelegramConnection();
                        } else {
                            console.log('Still no user, continuing polling...');
                            setTimeout(checkAuthLoop, 1000);
                        }
                    }
                };
                
                // Start polling after a short delay
                setTimeout(checkAuthLoop, 1000);
                
            } else {
                console.error('Firebase service not available');
                window.location.href = 'login.html';
            }
        });

        function goBack() {
            window.location.href = '1.html';
        }

        async function checkTelegramConnection() {
            try {
                // Check if user has Telegram linked
                const telegramLink = await firebaseService.db.collection('telegram_users')
                    .where('firebaseUserId', '==', currentUser.uid)
                    .get();

                if (!telegramLink.empty) {
                    const linkData = telegramLink.docs[0].data();
                    updateConnectionStatus(true, linkData.telegramChatId);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error checking Telegram connection:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected, chatId = null) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const linkButton = document.getElementById('linkButton');
            const unlinkButton = document.getElementById('unlinkButton');

            if (connected) {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                text.textContent = `Conectado (Chat ID: ${chatId})`;
                text.className = 'text-green-400';
                linkButton.style.display = 'none';
                unlinkButton.style.display = 'inline-block';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
                text.textContent = 'No conectado';
                text.className = 'text-yellow-400';
                linkButton.style.display = 'inline-block';
                unlinkButton.style.display = 'none';
            }
        }

        async function linkTelegramAccount() {
            const linkCode = document.getElementById('linkCode').value.trim();
            
            if (!linkCode) {
                alert('Por favor ingresa el c√≥digo de vinculaci√≥n');
                return;
            }

            try {
                // Save the link to Firestore
                await firebaseService.db.collection('telegram_users').add({
                    firebaseUserId: currentUser.uid,
                    telegramChatId: linkCode,
                    linkedAt: new Date(),
                    userEmail: currentUser.email
                });

                alert('‚úÖ Cuenta vinculada exitosamente!');
                checkTelegramConnection();
                document.getElementById('linkCode').value = '';
                
            } catch (error) {
                console.error('Error linking account:', error);
                alert('‚ùå Error vinculando la cuenta. Intenta de nuevo.');
            }
        }

        async function unlinkTelegramAccount() {
            if (!confirm('¬øEst√°s seguro de que quieres desvincular tu cuenta de Telegram?')) {
                return;
            }

            try {
                // Remove the link from Firestore
                const telegramLink = await firebaseService.db.collection('telegram_users')
                    .where('firebaseUserId', '==', currentUser.uid)
                    .get();

                if (!telegramLink.empty) {
                    await telegramLink.docs[0].ref.delete();
                }

                alert('‚úÖ Cuenta desvinculada exitosamente!');
                checkTelegramConnection();
                
            } catch (error) {
                console.error('Error unlinking account:', error);
                alert('‚ùå Error desvinculando la cuenta. Intenta de nuevo.');
            }
        }
    </script>
</body>
</html>
