<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Buddy Finanzas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <script type="module" src="firebase-config.js"></script>
</head>
<body class="bg-[#0f1618] min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo and Title -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-r from-[#a64fff] to-[#8a2aff] rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-wallet text-white text-2xl"></i>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">Buddy Finanzas</h1>
      <p class="text-gray-400 text-sm">Gestiona tus finanzas personales</p>
      <span class="text-xs text-gray-500">v2.3.5 - Firebase + Local</span>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="space-y-6">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
        <input type="email" id="email" required 
               class="w-full px-4 py-3 bg-[#1f292c] border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-[#a64fff] transition-colors"
               placeholder="tu@email.com">
      </div>
      
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Contraseña</label>
        <input type="password" id="password" required 
               class="w-full px-4 py-3 bg-[#1f292c] border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-[#a64fff] transition-colors"
               placeholder="••••••••">
      </div>

      <button type="submit" id="loginBtn" 
              class="w-full bg-gradient-to-r from-[#a64fff] to-[#8a2aff] text-white py-3 rounded-lg font-semibold hover:from-[#8a2aff] hover:to-[#6b1fff] transition-all duration-200 flex items-center justify-center">
        <span id="loginBtnText">Iniciar Sesión</span>
        <i id="loginBtnIcon" class="fas fa-spinner fa-spin ml-2 hidden"></i>
      </button>
    </form>

    <!-- Toggle Form -->
    <div class="text-center mt-6">
      <button id="toggleForm" class="text-[#a64fff] hover:text-[#8a2aff] text-sm font-medium transition-colors">
        ¿No tienes cuenta? <span id="toggleText">Crear cuenta</span>
      </button>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg text-red-400 text-sm hidden">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <span id="errorText"></span>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm hidden">
      <i class="fas fa-check-circle mr-2"></i>
      <span id="successText"></span>
    </div>
  </div>

  <script>
    class SimpleLoginManager {
      constructor() {
        this.isLoginMode = true;
        this.init();
      }

      init() {
        this.bindEvents();
        this.checkExistingUser();
      }

      bindEvents() {
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleSubmit();
        });

        document.getElementById('toggleForm').addEventListener('click', () => {
          this.toggleForm();
        });
      }

      checkExistingUser() {
        // Check if user is already logged in (simple localStorage check)
        const userEmail = localStorage.getItem('userEmail');
        if (userEmail) {
          // User is already logged in, redirect to main app
          window.location.href = '1.html';
        }
      }

      toggleForm() {
        this.isLoginMode = !this.isLoginMode;
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const toggleText = document.getElementById('toggleText');
        const formTitle = document.querySelector('h1');

        if (this.isLoginMode) {
          loginBtnText.textContent = 'Iniciar Sesión';
          toggleText.textContent = 'Crear cuenta';
          formTitle.textContent = 'Iniciar Sesión';
        } else {
          loginBtnText.textContent = 'Crear Cuenta';
          toggleText.textContent = 'Ya tengo cuenta';
          formTitle.textContent = 'Crear Cuenta';
        }
      }

      async handleSubmit() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginBtnIcon = document.getElementById('loginBtnIcon');

        // Show loading state
        loginBtn.disabled = true;
        loginBtnText.textContent = this.isLoginMode ? 'Iniciando...' : 'Creando...';
        loginBtnIcon.classList.remove('hidden');

        // Hide previous messages
        this.hideMessages();

        try {
          if (this.isLoginMode) {
            await this.handleLogin(email, password);
          } else {
            await this.handleSignUp(email, password);
          }
        } catch (error) {
          this.showError(error.message);
        } finally {
          // Reset button state
          loginBtn.disabled = false;
          loginBtnText.textContent = this.isLoginMode ? 'Iniciar Sesión' : 'Crear Cuenta';
          loginBtnIcon.classList.add('hidden');
        }
      }

      async handleLogin(email, password) {
        try {
          // Try Firebase login first
          if (window.FirebaseService) {
            const firebaseService = new window.FirebaseService();
            await firebaseService.signIn(email, password);
            
            // Get the Firebase user
            const firebaseUser = firebaseService.getCurrentUser();
            const userId = firebaseUser ? firebaseUser.uid : 'user_' + Date.now();
            
            // Store user data locally
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', userId);
            
            this.showSuccess('¡Inicio de sesión exitoso en Firebase! Redirigiendo...');
            
            setTimeout(() => {
              window.location.href = '1.html';
            }, 1500);
            return;
          }
        } catch (error) {
          // If Firebase fails, try local storage
        }

        // Fallback to local storage login
        const storedUser = localStorage.getItem('user_' + email);
        
        if (!storedUser) {
          throw new Error('Usuario no encontrado. Crea una cuenta primero.');
        }

        const userData = JSON.parse(storedUser);
        if (userData.password !== password) {
          throw new Error('Contraseña incorrecta.');
        }

        // Login successful
        localStorage.setItem('userEmail', email);
        localStorage.setItem('userId', userData.id);
        
        this.showSuccess('¡Inicio de sesión exitoso! Redirigiendo...');
        
        setTimeout(() => {
          window.location.href = '1.html';
        }, 1500);
      }

      async handleSignUp(email, password) {
        // Check if user already exists
        const existingUser = localStorage.getItem('user_' + email);
        if (existingUser) {
          throw new Error('Este email ya está registrado. Inicia sesión en su lugar.');
        }

        try {
          // Try to create user in Firebase first
          if (window.FirebaseService) {
            const firebaseService = new window.FirebaseService();
            await firebaseService.signUp(email, password);
            
            // Get the Firebase user ID
            const firebaseUser = firebaseService.getCurrentUser();
            const userId = firebaseUser ? firebaseUser.uid : 'user_' + Date.now();
            
            // Store user data locally
            const userData = {
              id: userId,
              email: email,
              password: password, // Note: This is just for local reference
              createdAt: new Date().toISOString(),
              firebaseUserId: userId
            };

            localStorage.setItem('user_' + email, JSON.stringify(userData));
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', userId);

            this.showSuccess('¡Cuenta creada exitosamente en Firebase! Redirigiendo...');
          } else {
            // Fallback to local storage only
            const userId = 'user_' + Date.now();
            const userData = {
              id: userId,
              email: email,
              password: password,
              createdAt: new Date().toISOString()
            };

            localStorage.setItem('user_' + email, JSON.stringify(userData));
            localStorage.setItem('userEmail', email);
            localStorage.setItem('userId', userId);

            this.showSuccess('¡Cuenta creada exitosamente! Redirigiendo...');
          }
          
          setTimeout(() => {
            window.location.href = '1.html';
          }, 1500);
          
        } catch (error) {
          // If Firebase fails, fall back to local storage
          const userId = 'user_' + Date.now();
          const userData = {
            id: userId,
            email: email,
            password: password,
            createdAt: new Date().toISOString()
          };

          localStorage.setItem('user_' + email, JSON.stringify(userData));
          localStorage.setItem('userEmail', email);
          localStorage.setItem('userId', userId);

          this.showSuccess('¡Cuenta creada exitosamente! Redirigiendo...');
          
          setTimeout(() => {
            window.location.href = '1.html';
          }, 1500);
        }
      }

      showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successDiv.classList.remove('hidden');
      }

      hideMessages() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('successMessage').classList.add('hidden');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new SimpleLoginManager();
    });
  </script>
</body>
</html>
