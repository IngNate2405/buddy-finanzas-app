<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Buddy Finanzas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <script type="module" src="firebase-config.js"></script>
</head>
<body class="bg-[#0f1618] min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo and Title -->
    <div class="text-center mb-8">
      <div class="w-20 h-20 bg-gradient-to-r from-[#a64fff] to-[#8a2aff] rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-wallet text-white text-2xl"></i>
      </div>
      <h1 class="text-2xl font-bold text-white mb-2">Buddy Finanzas</h1>
      <p class="text-gray-400 text-sm">Gestiona tus finanzas personales</p>
      <span class="text-xs text-gray-500">v2.3.6 - Firebase Auth</span>
    </div>

    <!-- Login Form -->
    <form id="loginForm" class="space-y-6">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
        <input type="email" id="email" required 
               class="w-full px-4 py-3 bg-[#1f292c] border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-[#a64fff] transition-colors"
               placeholder="tu@email.com">
      </div>
      
      <div>
        <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Contraseña</label>
        <input type="password" id="password" required 
               class="w-full px-4 py-3 bg-[#1f292c] border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-[#a64fff] transition-colors"
               placeholder="••••••••">
      </div>

      <button type="submit" id="loginBtn" 
              class="w-full bg-gradient-to-r from-[#a64fff] to-[#8a2aff] text-white py-3 rounded-lg font-semibold hover:from-[#8a2aff] hover:to-[#6b1fff] transition-all duration-200 flex items-center justify-center">
        <span id="loginBtnText">Iniciar Sesión</span>
        <i id="loginBtnIcon" class="fas fa-spinner fa-spin ml-2 hidden"></i>
      </button>
    </form>

    <!-- Toggle Form -->
    <div class="text-center mt-6">
      <button id="toggleForm" class="text-[#a64fff] hover:text-[#8a2aff] text-sm font-medium transition-colors">
        ¿No tienes cuenta? <span id="toggleText">Crear cuenta</span>
      </button>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="mt-4 p-3 bg-red-900/20 border border-red-500/30 rounded-lg text-red-400 text-sm hidden">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <span id="errorText"></span>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm hidden">
      <i class="fas fa-check-circle mr-2"></i>
      <span id="successText"></span>
    </div>

    <!-- Firebase Status -->
    <div id="firebaseStatus" class="mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-blue-400 text-sm">
      <i class="fas fa-info-circle mr-2"></i>
      <span id="firebaseStatusText">Verificando conexión con Firebase...</span>
    </div>
  </div>

  <script>
    class FirebaseLoginManager {
      constructor() {
        this.isLoginMode = true;
        this.firebaseService = null;
        this.init();
      }

      async init() {
        this.bindEvents();
        await this.checkFirebaseStatus();
        this.checkExistingUser();
      }

      async checkFirebaseStatus() {
        try {
          // Wait for Firebase to load
          await new Promise(resolve => {
            if (window.FirebaseService) {
              resolve();
            } else {
              const checkFirebase = setInterval(() => {
                if (window.FirebaseService) {
                  clearInterval(checkFirebase);
                  resolve();
                }
              }, 100);
            }
          });

          this.firebaseService = new window.FirebaseService();
          const statusText = document.getElementById('firebaseStatusText');
          statusText.textContent = '✅ Conectado a Firebase - Autenticación disponible';
          document.getElementById('firebaseStatus').className = 'mt-4 p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm';
        } catch (error) {
          const statusText = document.getElementById('firebaseStatusText');
          statusText.textContent = '⚠️ Firebase no disponible - Usando modo local';
          document.getElementById('firebaseStatus').className = 'mt-4 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded-lg text-yellow-400 text-sm';
        }
      }

      bindEvents() {
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleSubmit();
        });

        document.getElementById('toggleForm').addEventListener('click', () => {
          this.toggleForm();
        });
      }

      checkExistingUser() {
        // Check if user is already logged in
        const userEmail = localStorage.getItem('userEmail');
        if (userEmail) {
          // User is already logged in, redirect to main app
          window.location.href = '1.html';
        }
      }

      toggleForm() {
        this.isLoginMode = !this.isLoginMode;
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const toggleText = document.getElementById('toggleText');
        const formTitle = document.querySelector('h1');

        if (this.isLoginMode) {
          loginBtnText.textContent = 'Iniciar Sesión';
          toggleText.textContent = 'Crear cuenta';
          formTitle.textContent = 'Iniciar Sesión';
        } else {
          loginBtnText.textContent = 'Crear Cuenta';
          toggleText.textContent = 'Ya tengo cuenta';
          formTitle.textContent = 'Crear Cuenta';
        }
      }

      async handleSubmit() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginBtn = document.getElementById('loginBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const loginBtnIcon = document.getElementById('loginBtnIcon');

        // Show loading state
        loginBtn.disabled = true;
        loginBtnText.textContent = this.isLoginMode ? 'Iniciando...' : 'Creando...';
        loginBtnIcon.classList.remove('hidden');

        // Hide previous messages
        this.hideMessages();

        try {
          if (this.isLoginMode) {
            await this.handleLogin(email, password);
          } else {
            await this.handleSignUp(email, password);
          }
        } catch (error) {
          this.showError(error.message);
        } finally {
          // Reset button state
          loginBtn.disabled = false;
          loginBtnText.textContent = this.isLoginMode ? 'Iniciar Sesión' : 'Crear Cuenta';
          loginBtnIcon.classList.add('hidden');
        }
      }

      async handleLogin(email, password) {
        if (this.firebaseService) {
          try {
            // Try Firebase login
            await this.firebaseService.signIn(email, password);
            const user = this.firebaseService.getCurrentUser();
            
            if (user) {
              localStorage.setItem('userEmail', email);
              localStorage.setItem('userId', user.uid);
              
              this.showSuccess('¡Inicio de sesión exitoso en Firebase! Redirigiendo...');
              
              setTimeout(() => {
                window.location.href = '1.html';
              }, 1500);
              return;
            }
          } catch (error) {
            throw new Error('Error de autenticación: ' + error.message);
          }
        } else {
          throw new Error('Firebase no está disponible. Por favor, recarga la página.');
        }
      }

      async handleSignUp(email, password) {
        if (this.firebaseService) {
          try {
            // Try Firebase signup
            await this.firebaseService.signUp(email, password);
            const user = this.firebaseService.getCurrentUser();
            
            if (user) {
              localStorage.setItem('userEmail', email);
              localStorage.setItem('userId', user.uid);
              
              this.showSuccess('¡Cuenta creada exitosamente en Firebase! Redirigiendo...');
              
              setTimeout(() => {
                window.location.href = '1.html';
              }, 1500);
              return;
            }
          } catch (error) {
            if (error.code === 'auth/email-already-in-use') {
              throw new Error('Este email ya está registrado. Inicia sesión en su lugar.');
            } else if (error.code === 'auth/weak-password') {
              throw new Error('La contraseña debe tener al menos 6 caracteres.');
            } else if (error.code === 'auth/invalid-email') {
              throw new Error('El email no es válido.');
            } else {
              throw new Error('Error creando cuenta: ' + error.message);
            }
          }
        } else {
          throw new Error('Firebase no está disponible. Por favor, recarga la página.');
        }
      }

      showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successDiv.classList.remove('hidden');
      }

      hideMessages() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('successMessage').classList.add('hidden');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new FirebaseLoginManager();
    });
  </script>
</body>
</html>
